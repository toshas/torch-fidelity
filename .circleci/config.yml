version: 2.1


executors:
  executor_python:
    docker:
      - image: cimg/python:3.12.1
    working_directory: /tmp


jobs:
  venv:
    executor: executor_python
    steps:
      - checkout:
          path: code
      - run:
          name: Create virtual environment
          command: |
            python3 -m venv venv_fidelity
            . venv_fidelity/bin/activate
            pip3 install --upgrade pip
            pip3 install numpy pillow tqdm
      - persist_to_workspace:
          root: .
          paths:
            - venv_fidelity
            - code
  smoke_tests:
    executor: executor_python
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Smoke tests
          command: |
            . venv_fidelity/bin/activate
            cd code && CUDA_VISIBLE_DEVICES="" PYTHONPATH=. python3 ./.circleci/smoke_tests.py


aliases:
  - &jobs_all_tests
    - venv
    - smoke_tests:
        requires:
          - venv


workflows:
  version: 2
  venv_and_tests:
    jobs: *jobs_all_tests
  mondays:
    triggers:
      - schedule:
          cron: "0 0 * * 1"
          filters:
            branches:
              only:
                - master
    jobs: *jobs_all_tests
